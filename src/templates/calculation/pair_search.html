{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <h3 class="center-align section-title">{{ title }}</h3>
    </div>
</div>

<div class="row">
    <div class="col s12 m8 offset-m2">
        <div class="card z-depth-4 form-card">
            <div class="card-content">
                <form method="post">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                        <div class="card-panel red lighten-5 red-text text-darken-4">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}
                    {% if search_error %}
                        <div class="card-panel red lighten-5 red-text text-darken-4">
                            {{ search_error }}
                        </div>
                    {% endif %}
                    <div class="row">
                        <div class="input-field col s6 teacher-field">
                            <i class="material-icons prefix green-text">date_range</i>
                            {{ form.start_date }}
                            <label for="{{ form.start_date.id_for_label }}">Дата начала</label>
                            {{ form.start_date.errors }}
                        </div>
                        <div class="input-field col s6">
                            <i class="material-icons prefix green-text">date_range</i>
                            {{ form.end_date }}
                            <label for="{{ form.end_date.id_for_label }}">Дата окончания</label>
                            {{ form.end_date.errors }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="input-field col s6">
                            <i class="material-icons prefix green-text">person</i>
                            {{ form.teacher }}
                            <label for="{{ form.teacher.id_for_label }}">Преподаватель</label>
                            {{ form.teacher.errors }}
                            <ul id="teacher-suggestions" class="collection teacher-suggestions"></ul>
                        </div>
                        <div class="input-field col s6">
                            <i class="material-icons prefix green-text">book</i>
                            {{ form.subject }}
                            <label for="{{ form.subject.id_for_label }}">Предмет</label>
                            {{ form.subject.errors }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col s12 center-align">
                            <button type="submit" class="btn-large waves-effect waves-light green-bg">
                                Найти занятия
                                <i class="material-icons right">search</i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if search_performed %}
<div class="row">
    <div class="col s12">
        <h4 class="center-align">Результаты поиска</h4>
        <p class="center-align gray-text">Найдено строк: {{ pairs|length }}</p>
        
        {% if pairs %}
        <div class="card">
            <div class="card-content">
                <table class="striped highlight responsive-table">
                    <thead>
                        <tr>
                            <th class="date-col">Дата</th>
                            <th class="time-col">Часы от и до</th>
                            <th class="discipline-col">Дисциплина</th>
                            <th class="work-type-col">Вид выполняемой учебной работы</th>
                            <th class="course-col">Курс</th>
                            <th class="group-col">Группа</th>
                            <th class="hours-col">Количество часов</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pair in pairs %}
                        <tr>
                            <td class="date-col">{{ pair.date|date:"d.m.Y" }}</td>
                            <td class="time-col">{{ pair.time_range }}</td>
                            <td class="discipline-col">{{ pair.discipline }}</td>
                            <td class="work-type-col">{{ pair.work_type }}</td>
                            <td class="course-col">{{ pair.course }}</td>
                            <td class="group-col">{{ pair.group }}</td>
                            <td class="hours-col">{{ pair.hours }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-content center-align">
                <h5>Занятия не найдены</h5>
                <p>По вашему запросу не найдено ни одного занятия.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{{ teacher_options|json_script:"teacher-options" }}

<style>
    .teacher-field {
        position: relative;
    }
    .teacher-suggestions {
        display: none;
        position: absolute;
        left: 0;
        right: 0;
        top: 100%;
        margin-top: 8px;
        z-index: 10;
        max-height: 360px;
        overflow-y: auto;
    }
    .teacher-suggestions .collection-item {
        cursor: pointer;
    }
    .form-card {
        overflow: visible;
    }

    /* Table column alignment */
    .responsive-table {
        table-layout: fixed;
        width: 100%;
    }

    .date-col {
        width: 10%;
    }

    .time-col {
        width: 12%;
    }

    .discipline-col {
        width: 15%;
    }

    .work-type-col {
        width: 20%;
    }

    .course-col {
        width: 8%;
    }

    .group-col {
        width: 15%;
    }

    .hours-col {
        width: 10%;
    }

    /* Ensure text alignment */
    .responsive-table th,
    .responsive-table td {
        text-align: left;
        vertical-align: middle;
        word-wrap: break-word;
        padding: 12px 8px;
    }

    /* Center align numeric columns */
    .hours-col {
        text-align: center;
    }

    /* Adjust for medium and small screens */
    @media screen and (max-width: 1200px) {
        .work-type-col {
            width: 18%;
        }
        .discipline-col {
            width: 17%;
        }
    }

    @media screen and (max-width: 992px) {
        .responsive-table {
            display: block;
            overflow-x: auto;
        }

        .date-col {
            width: 15%;
        }

        .time-col {
            width: 15%;
        }

        .discipline-col {
            width: 20%;
        }

        .work-type-col {
            width: 25%;
        }

        .course-col {
            width: 10%;
        }

        .group-col {
            width: 18%;
        }

        .hours-col {
            width: 7%;
        }
    }

    /* Extra small screens */
    @media screen and (max-width: 768px) {
        .responsive-table {
            font-size: 0.85em;
        }

        .date-col,
        .time-col,
        .course-col,
        .hours-col {
            width: 12%;
        }

        .discipline-col,
        .work-type-col,
        .group-col {
            width: 20%;
        }

        .responsive-table th,
        .responsive-table td {
            padding: 8px 4px;
        }
    }

    /* Very small screens */
    @media screen and (max-width: 576px) {
        .responsive-table {
            font-size: 0.8em;
            display: block;
            overflow-x: auto;
        }

        .date-col,
        .time-col,
        .course-col,
        .hours-col {
            width: 15%;
        }

        .discipline-col,
        .work-type-col,
        .group-col {
            width: 20%;
        }

        .responsive-table th,
        .responsive-table td {
            padding: 6px 3px;
            font-size: 0.9em;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const teacherInput = document.getElementById('id_teacher');
    const minChars = 1;
    const suggestions = document.getElementById('teacher-suggestions');
    const dataElement = document.getElementById('teacher-options');
    if (!teacherInput || !suggestions || !dataElement) {
        return;
    }

    let allOptions = [];
    try {
        allOptions = JSON.parse(dataElement.textContent);
    } catch (error) {
        return;
    }

    const escapeHtml = (value) => value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

    const clearSuggestions = () => {
        suggestions.innerHTML = '';
        suggestions.style.display = 'none';
    };

    const updateList = () => {
        const value = teacherInput.value.trim().toLowerCase();
        let matches = [];
        if (value.length === 0) {
            matches = allOptions;
        } else if (value.length >= minChars) {
            matches = allOptions
                .filter(option => option.toLowerCase().includes(value));
        }
        if (matches.length === 0) {
            clearSuggestions();
            return;
        }

        suggestions.innerHTML = matches
            .map(option => `<li class="collection-item" data-value="${escapeHtml(option)}">${escapeHtml(option)}</li>`)
            .join('');
        suggestions.style.display = 'block';
    };

    suggestions.addEventListener('mousedown', (event) => {
        const item = event.target.closest('.collection-item');
        if (!item) {
            return;
        }
        teacherInput.value = item.getAttribute('data-value');
        clearSuggestions();
    });

    teacherInput.addEventListener('input', updateList);
    teacherInput.addEventListener('focus', updateList);
    teacherInput.addEventListener('blur', () => setTimeout(clearSuggestions, 150));
});
</script>
{% endblock %}
